using System;
using Microsoft.SPOT;
using Microsoft.SPOT.Hardware;
using System.Threading;
using Samraksh;

enum DETECTOR
{
    INTER_SAMP_TIME = 4, // sampling rate in ms
    SAMPRATE = 250,
   
 }

namespace MakerFairSensor
{
    public static class MessageHandler
    {
        public static byte[] payload = new byte[2];

        public static void init()
        {
            MessageLayer.Init();
        }

        public static void send(ushort[] samples)
        {
        	byte[] payload = new byte[4];
        	payload[0] = (byte) (samples[0] & 0xff);
        	payload[1] = (byte) ((samples[0] >> 8) & 0xff);
        	payload[2] = (byte) (samples[1] & 0xff);
        	payload[3] = (byte) ((samples[1] >> 8) & 0xff);
        	
            MessageLayer.Send(0, 0xffff, payload, 2);
        }
    }

    public class Program
    {
        public static ushort[] currSample = new ushort[2];
        public static OutputPort Gpio1 = new OutputPort((Cpu.Pin)9, false);

        public static void Main()
        {
            MessageHandler.init();
            ADC.Init(0x04);

            Timer sampleTimer = new Timer(sampleFired, null, (int)DETECTOR.INTER_SAMP_TIME, (int)DETECTOR.INTER_SAMP_TIME);

            while (true)
            {
                System.Threading.Thread.Sleep(10000);
            }
            
        }

        static void sampleFired(object o)
        {
            Gpio1.Write(true);
            Gpio1.Write(false);

            ADC.getData(currSample, 0, 2);

            MessageHandler.send(currSample);
        }

    }
}
